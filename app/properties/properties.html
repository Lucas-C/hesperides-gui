<div layout="row">
    <div flex="100">
        <div class="bg-light">
            <h3>Plateformes de <strong>{{application.name}}</strong></h3>
            <list-of-items items="platforms"
                           label="$item.name + ' v' + $item.application_version"
                           sorton="$item.name"
                           selected-item="platform"
                           createfunction="add_platform($name)"
                           ondelete="delete_platform($item)"
                           onedit="on_edit_platform($item)"
                           selectable="true"
                           editable="false"
                           size="small">
            </list-of-items>
        </div>
    </div>
</div>
<div layout="column" ng-show="platform" class="bg-light">

<script type="text/ng-template" id="application/search_module.html">
    <div class="modal-header">
        <h3 class="modal-title">Ajouter un module</h3>
    </div>
    <div class="modal-body">
        <form name="searchModuleForm" novalidate
              ng-submit="searchModuleForm.$valid && $close(moduleSearched)">
            <div class="form-group">
                <div class="col-lg-12">
                    <input type="text" class="form-control" id="module"
                           ng-model="moduleSearched"
                           placeholder="Rechercher" required
                           data-hint="par nom, version,..."
                           typeahead-editable="false"
                           typeahead="module as module.title for module in find_modules_by_name($viewValue)"
                            />
                </div>
            </div>
            <input type="submit" id="submit" value="Submit" ng-hide="true"/>
        </form>
    </div>
    <div class="modal-footer">
        <button class="btn btn-success" ng-disabled="searchModuleForm.$invalid"
                ng-click="$close(moduleSearched)" ng-hide="isReadOnly">Ok
        </button>
        <button class="btn btn-warning" ng-click="$dismiss('cancel')">Annuler</button>
    </div>
</script>

<script type="text/ng-template" id="application/change_module_version.html">
    <div class="modal-header">
        <h3 class="modal-title">Changer la version de {{module.title}}</h3>
    </div>
    <div class="modal-body">
        <form name="searchModuleForm" autocomplete="off" novalidate class="form-horizontal"
              ng-submit="searchModuleForm.$valid && $close({new_module: moduleSearched, copy_properties: copyProperties})">
            <div class="form-group">
                <div class="col-lg-12">
                    <input type="text" class="form-control" id="module"
                           ng-model="moduleSearched"
                           placeholder="Rechercher la nouvelle version" required
                           data-hint="entrer juste la version, la recherche filtre déjà sur le nom du module"
                           typeahead-editable="false"
                           typeahead="module as module.title for module in find_modules_by_name(module.name + ' ' + $viewValue) | filter:{name:module.name}"
                            />
                </div>
            </div>
            <div class="form-group vertical-align" ng-show="moduleSearched">
                <label class="col-lg-8 control-label" style="padding-top: 0"
                       ng-style="{'text-decoration': (copyProperties ? '' : 'line-through'), 'font-weight' : (copyProperties ? 'bold' : 'normal')}">Copier
                    les properties valorisées de la version {{module.version}} vers la version
                    {{moduleSearched.version}}</label>

                <div class="col-lg-4">
                    <div class="togglebutton">
                        <label>
                            <input type="checkbox" id="copyProperties" ng-model="copyProperties"/>
                        </label>
                    </div>
                </div>
            </div>
            <input type="submit" id="submit" value="Submit" ng-hide="true"/>
        </form>
    </div>
    <div class="modal-footer">
        <button class="btn btn-success" ng-disabled="searchModuleForm.$invalid"
                ng-click="$close({new_module: moduleSearched, copy_properties: copyProperties})"
                ng-hide="isReadOnly">Ok
        </button>
        <button class="btn btn-warning" ng-click="$dismiss('cancel')">Annuler</button>
    </div>
</script>

<script type="text/ng-template" id="application/add_box.html">
    <div class="modal-header">
        <h3 class="modal-title">Ajouter un groupe logique</h3>
    </div>
    <div class="modal-body">
        <form name="addComponentForm" novalidate
              ng-submit="addComponentForm.$valid && $close(new_component_name)">
            <label for="name">Nom</label>
            <input type="text" class="form-control" id="name"
                   ng-model="new_component_name"
                   placeholder="Exemple WDIGST,..." required/>
            <input type="submit" id="submit" value="Submit" ng-hide="true"/>
        </form>
    </div>
    <div class="modal-footer">
        <button class="btn btn-success" ng-disabled="addComponentForm.$invalid"
                ng-click="$close(new_component_name)" ng-hide="isReadOnly">Ok
        </button>
        <button class="btn btn-warning" ng-click="$dismiss('cancel')">Annuler</button>
    </div>
</script>

<script type="text/ng-template" id="application/add_instance.html">
    <div class="modal-header">
        <h3 class="modal-title">Ajouter une instance</h3>
    </div>
    <div class="modal-body">
        <form name="addInstanceForm" novalidate
              ng-submit="addInstanceForm.$valid && $close(new_instance_name)">
            <label for="name">Nom</label>
            <input type="text" class="form-control" id="name"
                   ng-model="new_instance_name" required/>
            <input type="submit" id="submit" value="Submit" ng-hide="true"/>
        </form>
    </div>
    <div class="modal-footer">
        <button class="btn btn-success" ng-disabled="addInstanceForm.$invalid"
                ng-click="$close(new_instance_name)" ng-hide="isReadOnly">Ok
        </button>
        <button class="btn btn-warning" ng-click="$dismiss('cancel')">Annuler</button>
    </div>
</script>

<script type="text/ng-template" id="box_renderer.html">
    <div id="header" class="vertical-align">
        <div class="col-md-6 text-left" style="padding-left:10px">
                <a href="" editable-text="name" title="Modifier le nom du groupe logique"
                                      onbeforesave="update_box_name(box, name, $data)">{{name}}</a>
        </div>
        <div class="col-md-6" style="padding-right:10px; justify-content: flex-end">
            <md-button ng-click="search_module(box)" tooltip="Ajouter un module"
                       class="md-btn-xs">
                <span class="glyphicon glyphicon-plus"></span>
            </md-button>
            <md-button ng-click="open_add_box_dialog(box)" tooltip="Ajouter un groupe logique"
                       class="md-btn-xs">
                <span class="glyphicon glyphicon-inbox"></span>
            </md-button>
            <md-button ng-really-message="Supprimer le groupe logique {{name}} ?" tooltip="Supprimer le groupe logique"
                       ng-really-click="remove_box(name, box)" ng-if="box.isEmpty()"
                       class="md-btn-xs md-warn">
                <span class="glyphicon glyphicon-trash"></span>
            </md-button>
        </div>
    </div>
    <ul class="list-inline box">
        <li class="jumbotron" ng-repeat="(name, box) in box.children"
            ng-include="'box_renderer.html'"></li>
        <li ng-if="box.modules.length > 0" class="jumbotron instance" ng-repeat="module in box.modules">
            <div id="header" style="height: 38px; width: 100%" class="col-md-12  vertical-align">
                <div class="col-md-6" style="padding-left:10px;white-space: nowrap;">
                                <span><strong><a href="" ng-click="change_module(module)"
                                                 title="Modifier la version du module">{{module.title}}</a></strong></span>
                </div>
                <div class="col-md-6" style="justify-content: flex-end">
                    <md-button ng-click="open_add_instance_dialog(module)" tooltip="Ajouter une instance"
                               class="md-btn-xs">
                        <span class="glyphicon glyphicon-plus"></span>
                    </md-button>
                    <md-button class="md-btn-xs" tooltip="Editer les properties"
                               ng-click="edit_properties(platform, module)"><span
                            class="glyphicon glyphicon-list"></span>
                    </md-button>
                    <md-button ng-really-message="Supprimer le module {{module.title}} et toutes ses instances ?"
                               tooltip="Supprimer le module"
                               ng-really-click="delete_module(module, box)"
                               class="md-btn-xs md-warn">
                        <span class="glyphicon glyphicon-trash"></span>
                    </md-button>
                </div>
            </div>
            <div>
                <ul class="list-inline" style="padding-top:10px; padding-bottom:10px;padding-left: 10px;">
                    <li ng-repeat="instance in module.instances | orderBy:'name':false"
                        ng-mouseover="instance.hover = true" ng-mouseleave="instance.hover = false">
                        <md-button ng-click="edit_instance(instance)" tooltip="Editer les properties de l'instance"
                                   class="">
                            <span class="glyphicon glyphicon-list" style="margin-right:10px"></span>{{instance.name}}
                        </md-button>
                        <md-button ng-really-message="Supprimer l'instance {{instance.name}} ?"
                                   tooltip="Supprimer l'instance"
                                   ng-really-click="delete_instance(instance, module)"
                                   class="md-warn" ng-show="instance.hover">
                            <span class="glyphicon glyphicon-trash"></span>
                        </md-button>
                    </li>
                </ul>
            </div>
        </li>
    </ul>
</script>

<div layout="row" class="vertical-align">
    <div flex="66">
        <h3><span>Representation logique de <strong>{{platform.name}} (version
            <a href="" editable-text="platform.application_version"
               title="Modifier le label 'version de l'application'"
               onaftersave="save_platform_from_box(mainBox)">{{platform.application_version}}</a>
            )</strong></span>
        </h3>
    </div>
    <div flex="33">
        <div layout="row" layout-align="end center">
            <h3 class="togglebutton">
                <span style="padding-right: 10px">Plateforme de production</span>
                <label>
                    <input type="checkbox" ng-model="platform.production" ng-change="save_platform_from_box(mainBox)"
                           id="isProduction"/>
                </label>
            </h3>
        </div>
    </div>
</div>


<!--
<button ng-click="save_platform_from_box(mainBox, true)" class="btn btn-sm">
    <span class="glyphicon glyphicon-saved" style="padding-right:10px"></span>
    <span>Sauver la plateforme</span>
</button>
-->
<div layout="row" layout-wrap>
    <div flex="5">
        <md-button ng-click="open_add_box_dialog(mainBox)" class="md-fab md-btn-xs"
                   style="color: black;background-color: white">
            <span class="glyphicon glyphicon-inbox"></span>
            <md-tooltip>
                Ajouter un groupe logique
            </md-tooltip>
        </md-button>
    </div>
    <div flex="95">
        <ul class="list-inline box">
            <li class="jumbotron" ng-repeat="(name, box) in mainBox.children" ng-include="'box_renderer.html'"/>
            <li class="jumbotron" ng-if="box.modules.length > 0">
                <button class="btn btn-info btn-sm" style="margin: 5px 5px 5px 5px"
                        ng-repeat="module in mainBox.modules">{{module.title}} <span
                        class="glyphicon glyphicon-list"></span></button>
            </li>
        </ul>
    </div>
</div>

<div layout="row" ng-show="properties">
    <div class="col-md-12">
        <h3><span style="margin-right: 30px">Les properties associees a <strong>{{selected_module.path.split('#').join('
            | ')}} | {{selected_module.title}}</strong></span>
            <button ng-click="save_properties(properties, selected_module)" class="btn btn-sm">
                <span class="glyphicon glyphicon-saved" style="padding-right:10px"></span>
                <span>Sauver les properties</span>
            </button>
        </h3>
        <properties-list properties="properties">
        </properties-list>
    </div>
</div>
<div layout="row" ng-show="instance">
    <div class="col-md-12">
        <h3>
                <span style="margin-right: 30px">Les properties d'instance associees a <strong><a href=""
                                                                                                  editable-text="instance.name"
                                                                                                  onbeforesave="update_instance_name(instance, $data)">{{instance.name}}</a></strong></span>
            <button ng-click="save_platform_from_box(mainBox)" class="btn btn-sm">
                <span class="glyphicon glyphicon-saved" style="padding-right:10px"></span>
                <span>Sauver les properties</span>
            </button>
        </h3>
        <form class="form-horizontal narrow" role="form">
            <div class="form-group" ng-class="{'property-not-used': !key_value_property.inModel}"
                 ng-repeat="key_value_property in instance.key_values | orderBy:'name' track by $index">
                <label for="input-{{ key_value_property.name }}" class="col-md-3 control-label">{{
                    key_value_property.name }}</label>

                <div class="col-md-9">
                    <input id="input-{{ key_value_property.name }}" type="text" class="form-control"
                           placeholder="{{key_value_property.comment}}" ng-model="key_value_property.value"
                           tooltip="{{key_value_property.comment}}" tooltip-trigger="focus"
                           tooltip-placement="right"/>
                </div>
            </div>
        </form>
    </div>
</div>
</div>