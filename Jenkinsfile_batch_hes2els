#!groovy

// Contexte : https://jira.vsct.fr/browse/USL-1073

pipeline {
    agent {
        node {
            label 'default||master'
        }
    }
    triggers {
        cron('0 1,13 * * 1-5')
    }
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
    }
    parameters {
        string(name: 'ELS_URL', defaultValue: 'http://elasticsearch-log-master-assemblage-lille-s1.socrate.vsct.fr:52300')
        string(name: 'URL_HES', defaultValue: 'https://hesperides.socrate.vsct.fr')
    }
    environment {
        PYTHONUNBUFFERED = 1
    }
    stages {
        stage("Pull Project") {
            steps {
                script {
                    git(url: 'git@gitlab.socrate.vsct.fr:hesperides/search_hesperides.git',
                        branch: 'master')
                }
            }
        }
        stage("Scrapping d'Hesperides") {
            steps {
                script {
                    sh "ELS_URL=${ELS_URL} URL_HES=${URL_HES} scripts/search_all_wrapper.sh"
                    sh 'ls -l cache/'
                }
            }
        }
        stage('Upload dans Elasticsearch') {
            steps {
                script {
                    sh "ELS_URL=${ELS_URL} http_proxy= scripts/els_upload.sh"
                }
            }
        }
    }
    post {
        always {
            deleteDir()
        }
    }
}
